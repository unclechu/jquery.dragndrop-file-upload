/**
 * Drag'n'drop file upload module
 *
 * @module dragndrop_file_upload
 * @exports DragNDropFileUpload, Uploader (as DragNDropFileUpload.Uploader)
 * @requires jquery
 * @requires HTML5 FileAPI
 * @requires XMLHttpRequest
 *
 * @version r6
 * @author Viacheslav Lotsmanov <lotsmanov89@gmail.com>
 * @license GNU/GPLv3 by Free Software Foundation (https://github.com/unclechu/js-useful-amd-modules/blob/master/GPLv3-LICENSE)
 * @see {@link https://github.com/unclechu/js-useful-amd-modules/|GitHub}
 */
define(["jquery"],function(e){function r(e){function r(){}return Object.create?Object.create(e):(r.prototype=e,new r)}function a(){if(!window.FileReader)return new o.exceptions.FileReaderIsNotSupported;if(!window.XMLHttpRequest)return new o.exceptions.XMLHttpRequestIsNotSupported;if(!(new XMLHttpRequest).sendAsBinary){if(!(Array.prototype.map instanceof Function))return new o.exceptions.ArrayPrototypeMapIsNotSupported;if(!window.Uint8Array)return new o.exceptions.Uint8ArrayIsNotSupported}return null}function t(r,n){var s,i=this;if(i._callback=n,n=void 0,"undefined"!==e.type(i._callback)&&!(i._callback instanceof Function))throw new t.exceptions.IncorrectArgument(null,"callback");if("undefined"===e.type(r))return i.makeError(new t.exceptions.NoParams),!1;if(!e.isPlainObject(r))return i.makeError(new o.exceptions.IncorrectArgument(null,"params")),!1;var p=a();if(null!==p)return i.makeError(p),!1;if(i.params=e.extend({},l,r||{}),!("dragndropArea"in r))return i.makeError(new t.exceptions.RequiredParam(null,"dragndropArea")),!1;if(!(r.dragndropArea instanceof e)&&"object"!==e.type(r.dragndropArea)&&"string"!==e.type(r.dragndropArea))return i.makeError(new t.exceptions.IncorrectParamValue(null,"dragndropArea")),!1;if(e(r.dragndropArea).size()<=0)return i.makeError(new t.exceptions.DragNDropAreaBlockNotFound),!1;if(!("uploadUrl"in r))return i.makeError(new t.exceptions.RequiredParam(null,"uploadUrl")),!1;if("string"!==e.type(r.uploadUrl))return i.makeError(new t.exceptions.IncorrectParamValue(null,"uploadUrl")),!1;if("fileFieldName"in r&&"string"!==e.type(r.fileFieldName))return i.makeError(new t.exceptions.IncorrectParamValue(null,"fileFieldName")),!1;if("progressCallback"in r&&!(r.progressCallback instanceof Function)&&null!==r.progressCallback)return i.makeError(new t.exceptions.IncorrectParamValue(null,"progressCallback")),!1;if("addFileCallback"in r&&!(r.addFileCallback instanceof Function)&&null!==r.progressCallback)return i.makeError(new t.exceptions.IncorrectParamValue(null,"addFileCallback")),!1;if("endCallback"in r&&!(r.endCallback instanceof Function)&&null!==r.progressCallback)return i.makeError(new t.exceptions.IncorrectParamValue(null,"endCallback")),!1;if("dragOverClass"in r&&"string"!==e.type(r.dragOverClass))return i.makeError(new t.exceptions.IncorrectParamValue(null,"dragOverClass")),!1;if("bindSuffix"in r&&"string"!==e.type(r.bindSuffix))return i.makeError(new t.exceptions.IncorrectParamValue(null,"bindSuffix")),!1;if("postData"in r&&"object"!==e.type(r.postData))return i.makeError(new t.exceptions.IncorrectParamValue(null,"postData")),!1;for(s in r.postData)if("string"!==e.type(r.postData[s])&&"number"!==e.type(r.postData[s]))return i.makeError(new t.exceptions.IncorrectParamValue(null,"postData")),!1;if("uploaderInitCallback"in r&&!(r.uploaderInitCallback instanceof Function)&&null!==r.uploaderInitCallback)return i.makeError(new t.exceptions.IncorrectParamValue(null,"uploaderInitCallback")),!1;for(s in r)if(!(s in l))return i.makeError(new t.exceptions.UnknownParameter(null,s)),!1;r=void 0,i.params.dragndropArea=e(i.params.dragndropArea),i._uploaders=[],i._lastID=0,i.params.dragndropArea.on("dragenter"+i.params.bindSuffix,function(){return e(this).addClass(i.params.dragOverClass),!1}).on("dragover"+i.params.bindSuffix,function(){return!1}).on("dragleave"+i.params.bindSuffix,function(){return e(this).removeClass(i.params.dragOverClass),!1}).on("drop"+i.params.bindSuffix,function(r){e(this).removeClass(i.params.dragOverClass);var a=r.originalEvent.dataTransfer;return e.each(a.files,function(r,a){var n=!0;if(e.each(i.params.mimeTypeFilter,function(e,r){a.type.match(r)||(n=!1)}),n){var s=++i._lastID,l=e.extend({},i.params.postData);new o(i,{id:s,file:a,url:i.params.uploadUrl,fileFieldName:i.params.fileFieldName,postData:l},function(e){if(e)return void(i.params.addFileCallback instanceof Function&&setTimeout(function(){i.params.addFileCallback.call(null,e,s)},1));var r=this;i._uploaders.push(r),setTimeout(function(){i.params.addFileCallback instanceof Function&&i.params.addFileCallback.call(r,null,s,a.name,a.size,a.type),i.params.uploaderInitCallback instanceof Function&&i.params.uploaderInitCallback.call(r),r.startUploading()},1)})}else i.params.addFileCallback instanceof Function&&setTimeout(function(){i.params.addFileCallback.call(null,new t.exceptions.IncorrectMIMEType(null,a.type,a.name),s)},1)}),!1}),i._callback&&setTimeout(e.proxy(i._callback,i,null),1)}function n(e){return 255&e.charCodeAt(0)}function s(e){if(this.sendAsBinary)this.sendAsBinary(e);else{var r=Array.prototype.map.call(e,n),a=new window.Uint8Array(r);this.send(a)}}function o(r,n,i){var l,c=this;if(c._callback=i,i=void 0,"undefined"===e.type(c._callback))throw new o.exceptions.NoCallback;if(!(c._callback instanceof Function))throw new o.exceptions.IncorrectArgument(null,"callback");if(!(r instanceof t))return c.makeError(new o.exceptions.IncorrectSuperclass),!1;if("undefined"===e.type(n))return c.makeError(new o.exceptions.NoParams),!1;if(!e.isPlainObject(n))return c.makeError(new o.exceptions.IncorrectArgument(null,"params")),!1;var u=a();if(null!==u)return c.makeError(u),!1;if(c.superclass=r,r=void 0,c.params=e.extend({},p,n||{}),!("id"in n))return c.makeError(new o.exceptions.RequiredParam(null,"id")),!1;if("number"!==e.type(n.id))return c.makeError(new o.exceptions.IncorrectParamValue(null,"id")),!1;if(!("file"in n))return c.makeError(new o.exceptions.RequiredParam(null,"file")),!1;if("object"!==e.type(n.file))return c.makeError(new o.exceptions.IncorrectParamValue(null,"file")),!1;if(!("name"in n.file))return c.makeError(new o.exceptions.RequiredParam(null,"file.name")),!1;if("string"!==e.type(n.file.name))return c.makeError(new o.exceptions.IncorrectParamValue(null,"file.name")),!1;if(!("size"in n.file))return c.makeError(new o.exceptions.RequiredParam(null,"file.size")),!1;if("number"!==e.type(n.file.size))return c.makeError(new o.exceptions.IncorrectParamValue(null,"file.size")),!1;if(!("type"in n.file))return c.makeError(new o.exceptions.RequiredParam(null,"file.type")),!1;if("string"!==e.type(n.file.type))return c.makeError(new o.exceptions.IncorrectParamValue(null,"file.type")),!1;if(!("url"in n))return c.makeError(new o.exceptions.RequiredParam(null,"url")),!1;if("string"!==e.type(n.url))return c.makeError(new o.exceptions.IncorrectParamValue(null,"url")),!1;if("undefined"!==e.type(n.fileFieldName)&&"string"!==e.type(n.fileFieldName))return c.makeError(new o.exceptions.IncorrectParamValue(null,"fileFieldName")),!1;if("postData"in n&&"object"!==e.type(n.postData))return c.makeError(new o.exceptions.IncorrectParamValue(null,"postData")),!1;for(l in n.postData)if("string"!==e.type(n.postData[l])&&"number"!==e.type(n.postData[l]))return c.makeError(new o.exceptions.IncorrectParamValue(null,"postData")),!1;for(l in n)if(!(l in p))return c.makeError(new o.exceptions.UnknownParameter(null,l)),!1;n=void 0,c._xhr=new XMLHttpRequest,c._reader=new FileReader,c.progress=null,c.total=null,c.loaded=null,c.finished=!1,c.successful=null,c.started=!1,c.aborted=!1,c._toPost=e.extend({},c.params.postData),c._reader.onload=function(){c._xhr.upload.addEventListener("progress",function(e){e.lengthComputable&&(null===c.total&&(c.total=e.total),c.loaded=e.loaded,c.progress=100*c.loaded/c.total,c.superclass.params.progressCallback instanceof Function&&c.superclass.params.progressCallback.call(c,c.params.id,c.progress,c.loaded,c.total))},!1),c._xhr.upload.addEventListener("load",function(){c.progress=100,c.finished=!0,c.superclass.params.progressCallback instanceof Function&&c.superclass.params.progressCallback.call(c,c.params.id,c.progress,c.loaded,c.total)}),c._xhr.upload.addEventListener("error",function(){c._xhr.onreadystatechange=null,c.superclass.params.endCallback instanceof Function&&setTimeout(function(){c.superclass.params.endCallback.call(c,new o.exceptions.XHRUploadError(null,c.params.file.name),c.params.id)},1)}),c._xhr.onreadystatechange=function(){if(4===this.readyState){if(c.aborted)return;if(200===this.status)if(c.finished){c.successful=!0;var e=this.responseText;c.superclass.params.endCallback instanceof Function&&setTimeout(function(){c.superclass.params.endCallback.call(c,null,c.params.id,e)},1)}else c.successful=!1,c.superclass.params.endCallback instanceof Function&&setTimeout(function(){c.superclass.params.endCallback.call(c,new o.exceptions.ResponseBeforeFinished(null,c.params.file.name),c.params.id)},1);else c.successful=!1,c.superclass.params.endCallback instanceof Function&&setTimeout(function(){c.superclass.params.endCallback.call(c,new o.exceptions.ResponseStatusCodeError(null,c.params.file.name,this.status),c.params.id)},1)}},c._xhr.open("POST",c.params.url,!0);var e="xxxxxxxxx";c._xhr.setRequestHeader("Content-Type","multipart/form-data, boundary="+e),c._xhr.setRequestHeader("Cache-Control","no-cache"),c._xhr.setRequestHeader("Pragma","no-cache"),c._xhr.setRequestHeader("Expires","0");var r="";r+="--"+e+"\r\n",r+='Content-Disposition: form-data; charset: utf-8; accept-charset: utf-8; name="'+c.params.fileFieldName+'"; filename="'+unescape(encodeURIComponent(c.params.file.name))+'"\r\n',r+="Content-Type: application/octet-stream\r\n\r\n",r+=c._reader.result+"\r\n";for(var a in c._toPost)r+="--"+e+"\r\n",r+='Content-Disposition: form-data; name="'+a+'"\r\n',r+="Content-Type: text/plain; charset=utf-8\r\n\r\n",r+=c._toPost[a].toString()+"\r\n";r+="--"+e+"--",s.call(c._xhr,r)},c._callback&&setTimeout(e.proxy(c._callback,c,null),1)}var i,l={dragndropArea:null,uploadUrl:null,fileFieldName:"file",progressCallback:null,addFileCallback:null,endCallback:null,dragOverClass:"dragndrop_over",bindSuffix:".dragndrop_file_upload",mimeTypeFilter:[/.*/],postData:null,uploaderInitCallback:null};t.prototype.makeError=function(r){var a=this;if(a._callback)return setTimeout(e.proxy(a._callback,a,r),1),!0;throw r},t.prototype.destroy=function(){var r=this;e.each(r._uploaders,function(e,r){r.destroy()}),r.params.dragndropArea.off("dragenter"+r.params.bindSuffix).off("dragover"+r.params.bindSuffix).off("dragleave"+r.params.bindSuffix).off("drop"+r.params.bindSuffix),r._callback=void 0,r.params=void 0,r._uploaders=void 0},t.prototype.abort=function(r){var a=this,n=!1;if("number"!==e.type(r))throw new t.exceptions.IncorrectUploadId(null,r);if(e.each(a._uploaders,function(e,a){if(a.params.id===r){if(!a.started)throw new o.exceptions.UploadingIsNotStarted;a.abort(),n=!0}}),!n)throw new t.exceptions.UploaderNotFoundById(null,r)},t.exceptions={},t.exceptions.IncorrectArgument=function(e,r){Error.call(this),this.name="IncorrectArgument",r&&(this.argumentName=r),e?this.message=e:(this.message="Incorrect ",r&&(this.message+='"'+r+'" '),this.message+="argument value.")},t.exceptions.NoParams=function(e){Error.call(this),this.name="NoParams",this.message=e||"No params."},t.exceptions.IncorrectParamValue=function(e,r){Error.call(this),this.name="IncorrectParamValue",r&&(this.paramName=r),e?this.message=e:(this.message="Incorrect ",r&&(this.message+='"'+r+'" '),this.message+="param value.")},t.exceptions.RequiredParam=function(e,r){Error.call(this),this.name="RequiredParam",r&&(this.paramName=r),e?this.message=e:(this.message="Param ",r&&(this.message+='"'+r+'" '),this.message+="is required.")},t.exceptions.DragNDropAreaBlockNotFound=function(e){Error.call(this),this.name="DragNDropAreaBlockNotFound",this.message=e||'Drag&drop block not found by param value "dragndropArea".'},t.exceptions.UnknownParameter=function(e,r){Error.call(this),this.name="UnknownParameter",r&&(this.paramName=r),e?this.message=e:(this.message="Unknown parameter",r&&(this.message+=' "'+r+'"'),this.message+=".")},t.exceptions.IncorrectMIMEType=function(e,r,a){Error.call(this),this.name="IncorrectMIMEType",r&&(this.mimeType=r),a&&(this.filename=a),e?this.message=e:(this.message="Incorrect MIME-type",r&&(this.message+=' "'+r+'"'),this.message+=" of file",a&&(this.message+=' "'+a+'"'),this.message+=".")},t.exceptions.IncorrectUploadId=function(r,a){Error.call(this),this.name="IncorrectUploadId",a&&(this.uploadId=a),r?this.message=r:(this.message="Incorrect type of upload ID",a&&(this.message+=' ("'+e.type(a)+'")'),this.message+=', must be a "number".')},t.exceptions.UploaderNotFoundById=function(e,r){Error.call(this),this.name="UploaderNotFoundById",r&&(this.uploadId=r),e?this.message=e:(this.message="Uploader not found by ID",r&&(this.message+=': "'+r+'"'),this.message+=".")};for(i in t.exceptions)t.exceptions[i].prototype=r(Error.prototype);var p={id:null,file:null,url:null,fileFieldName:"file",postData:null};o.prototype.makeError=function(r){var a=this;if(a._callback)return setTimeout(e.proxy(a._callback,a,r),1),!0;throw r},o.prototype.destroy=function(){var e=this;e.superclass=void 0,e._callback=void 0,e.params=void 0,e._xhr=void 0,e._reader=void 0,e.progress=void 0,e.total=void 0,e.loaded=void 0,e.finished=void 0,e.started=void 0,e._toPost=void 0},o.prototype.extendPostData=function(r){var a=this;if(a.started)throw new o.exceptions.UploadingIsStarted;a._toPost=e.extend({},a._toPost,r)},o.prototype.abort=function(){var e=this;if(!e.started)throw new o.exceptions.UploadingIsNotStarted;if(e.aborted)throw new o.exceptions.UploadingIsAlreadyAborted;if(e.finished)throw new o.exceptions.UploadingIsFinished;e.aborted=!0,e._xhr.abort(),e.successful=!1,e.finished=!0},o.prototype.startUploading=function(){var e=this;e.started=!0,setTimeout(function(){e._reader.readAsBinaryString(e.params.file)},1)},o.exceptions={},o.exceptions.IncorrectSuperclass=function(e){Error.call(this),this.name="IncorrectSuperclass",this.message=e||'Superclass must be an instanceof "DragNDropFileUpload".'},o.exceptions.IncorrectArgument=function(e,r){Error.call(this),this.name="IncorrectArgument",r&&(this.argumentName=r),e?this.message=e:(this.message="Incorrect ",r&&(this.message+='"'+r+'" '),this.message+="argument value.")},o.exceptions.NoCallback=function(e){Error.call(this),this.name="NoCallback",this.message=e||"No callback."},o.exceptions.NoParams=function(e){Error.call(this),this.name="NoParams",this.message=e||"No params."},o.exceptions.IncorrectParamValue=function(e,r){Error.call(this),this.name="IncorrectParamValue",r&&(this.paramName=r),e?this.message=e:(this.message="Incorrect ",r&&(this.message+='"'+r+'" '),this.message+="param value.")},o.exceptions.RequiredParam=function(e,r){Error.call(this),this.name="RequiredParam",r&&(this.paramName=r),e?this.message=e:(this.message="Param ",r&&(this.message+='"'+r+'" '),this.message+="is required.")},o.exceptions.UnknownParameter=function(e,r){Error.call(this),this.name="UnknownParameter",r&&(this.paramName=r),e?this.message=e:(this.message="Unknown parameter",r&&(this.message+=' "'+r+'"'),this.message+=".")},o.exceptions.UploadingIsStarted=function(e){Error.call(this),this.name="UploadingIsStarted",this.message=e||"Uploading is started."},o.exceptions.UploadingIsNotStarted=function(e){Error.call(this),this.name="UploadingIsNotStarted",this.message=e||"Uploading is not started."},o.exceptions.UploadingIsAlreadyAborted=function(e){Error.call(this),this.name="UploadingIsAlreadyAborted",this.message=e||"Uploading is already aborted."},o.exceptions.UploadingIsFinished=function(e){Error.call(this),this.name="UploadingIsFinished",this.message=e||"Uploading is finished."},o.exceptions.UploadError=function(e,r){Error.call(this),this.name="UploadError",r&&(this.filename=r),e?this.message=e:(this.message="Upload file",r&&(this.message+=' "'+r+'"'),this.message+=" to server error.")},o.exceptions.UnsupportedFeature=function(e){Error.call(this),this.name="UnsupportedFeature",this.message=e||"Unsupported feature."};for(i in o.exceptions)o.exceptions[i].prototype=r(Error.prototype);return o.exceptions.XHRUploadError=function(e,r){Error.call(this),this.name="XHRUploadError",r&&(this.filename=r),e?this.message=e:(this.message="Upload file",r&&(this.message+=' "'+r+'"'),this.message+=" to server error.")},o.exceptions.XHRUploadError.prototype=r(o.exceptions.UploadError.prototype),o.exceptions.ResponseStatusCodeError=function(e,r,a){Error.call(this),this.name="ResponseStatusCodeError",r&&(this.filename=r),a&&(this.statusCode=a),e?this.message=e:(this.message="Upload file",r&&(this.message+=' "'+r+'"'),this.message+=" to server error because status code is not: 200 OK",a&&(this.message+=' (response status code: "'+a+'")'),this.message+=".")},o.exceptions.ResponseStatusCodeError.prototype=r(o.exceptions.UploadError.prototype),o.exceptions.ResponseBeforeFinished=function(e,r){Error.call(this),this.name="ResponseBeforeFinished",r&&(this.filename=r),e?this.message=e:(this.message="Upload file",r&&(this.message+=' "'+r+'"'),this.message+=" to server error (response before finished, may be timeout).")},o.exceptions.ResponseBeforeFinished.prototype=r(o.exceptions.UploadError.prototype),o.exceptions.FileReaderIsNotSupported=function(e){Error.call(this),this.name="FileReaderIsNotSupported",this.message=e||"FileReader is not supported."},o.exceptions.FileReaderIsNotSupported.prototype=r(o.exceptions.UnsupportedFeature.prototype),o.exceptions.XMLHttpRequestIsNotSupported=function(e){Error.call(this),this.name="XMLHttpRequestIsNotSupported",this.message=e||"XMLHttpRequest is not supported."},o.exceptions.XMLHttpRequestIsNotSupported.prototype=r(o.exceptions.UnsupportedFeature.prototype),o.exceptions.ArrayPrototypeMapIsNotSupported=function(e){Error.call(this),this.name="ArrayPrototypeMapIsNotSupported",this.message=e||"Array.prototype.map is not supported."},o.exceptions.ArrayPrototypeMapIsNotSupported.prototype=r(o.exceptions.UnsupportedFeature.prototype),o.exceptions.Uint8ArrayIsNotSupported=function(e){Error.call(this),this.name="Uint8ArrayIsNotSupported",this.message=e||"Uint8Array is not supported."},o.exceptions.Uint8ArrayIsNotSupported.prototype=r(o.exceptions.UnsupportedFeature.prototype),t.Uploader=o,t});